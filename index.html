<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafePath - Women's Safety & AI Guide</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* --- CUSTOM CSS --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background: #02091b;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Phone frame */
        .phone {
            width: 380px;
            height: 650px;
            border-radius: 32px;
            background: radial-gradient(circle at top, #13284b, #020918);
            padding: 14px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
        }

        /* Smartwatch Frame Styles */
        .watch-frame {
            width: 300px;
            height: 300px;
            border-radius: 40px; /* Rounded square aesthetic */
            background: radial-gradient(circle at top, #364052, #181c24);
            padding: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            border-radius: 26px;
            background: #020b1f;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        /* SOS banner - Base styles for integration */
        .sos-banner {
            background: #ff3b30;
            border-radius: 18px;
            padding: 14px 16px;
            color: #ffffff;
            text-align: center;
            cursor: pointer;
            position: relative; /* Needed for progress bar overlay */
            overflow: hidden;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        /* Progress Bar for press-and-hold */
        .sos-progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            transition: width 0.05s linear; /* Smooth fill */
            z-index: 1;
        }
        
        /* SOS Active state */
        .sos-banner.active {
            background: #8b0000;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from { box-shadow: 0 0 10px rgba(255, 60, 60, 0.8), 0 0 0 5px rgba(255, 0, 0, 0.4); }
            to { box-shadow: 0 0 20px rgba(255, 60, 60, 1), 0 0 0 10px rgba(255, 0, 0, 0.6); }
        }

        .sos-content {
            position: relative;
            z-index: 2; /* Keep content above progress bar */
        }
        
        .sos-title {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .sos-subtitle {
            margin-top: 4px;
            font-size: 13px;
            opacity: 0.9;
        }

        /* Card styles used for all three panels */
        .card {
            background: #07152b;
            border-radius: 18px;
            padding: 10px 12px;
            color: #f5f8ff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            min-height: 150px; 
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: #9fb3ff;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }

        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* Specific styles for Gen Card */
        .gemini-card {
            border: 2px solid #ec4899; /* Pink border */
        }
        
        /* Utility for spinning loader */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Make it scale a bit on small screens */
        @media (max-width: 420px) {
            .phone {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                padding: 0;
            }
            .watch-frame {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                padding: 12px;
            }

            .screen {
                border-radius: 0;
                padding: 12px;
            }
        }
        
        /* Voice specific styles */
        .mic-pulse {
            animation: mic-pulse 1s infinite;
        }
        @keyframes mic-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Ensure the main content area scrolls if elements exceed height */
        .scrollable-content {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 4px; /* Space for scrollbar */
        }
        
        /* Map specific styles */
        .map-container {
            position: relative;
            height: 150px; /* Increased height for map visibility */
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .map-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%); /* Position marker base at center */
            font-size: 24px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- React component mounts here -->
    </div>

    <script type="text/babel">
        // --- React Code Start ---

        const { useState, useEffect, useCallback } = React;

        // --- Global Variables and Constants ---

        const apiKey = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

        // Utility functions (TTS related - kept for structural completeness but not used)
        function base64ToArrayBuffer(base64) { return new ArrayBuffer(0); }
        function pcmToWav(pcm16, sampleRate = 16000) { return new Blob([], { type: 'audio/wav' }); }


        // --- Main Application Component ---

        const App = () => {
            const [isSOSActive, setIsSOSActive] = useState(false);
            // Updated location format to be Lat: X¬∞ Lon: Y¬∞
            const [currentLocation, setCurrentLocation] = useState("Lat: 37.774929¬∞ Lon: -122.419416¬∞");
            const [routeStart, setRouteStart] = useState("My Current Location (Auto)");
            const [routeEnd, setRouteEnd] = useState("1024 Market St, San Francisco");
            const [safetyAnalysis, setSafetyAnalysis] = useState(null);
            const [searchQuery, setSearchQuery] = useState("Safety analysis for route from " + routeStart + " to " + routeEnd + " at 10 PM tonight.");
            const [isLoading, setIsLoading] = useState(false);
            const [locationError, setLocationError] = useState(null);
            const [isWatchView, setIsWatchView] = useState(false);
            
            // State for voice interaction simulation
            const [isRecording, setIsRecording] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            
            // New state for press-and-hold logic
            const [sosPressProgress, setSosPressProgress] = useState(0); // 0 to 100
            const [sosPressTimerId, setSosPressTimerId] = useState(null);
            const PRESS_DURATION = 3000; // 3 seconds
            
            // State for contacts
            const [trustedContacts, setTrustedContacts] = useState([
                { id: 1, name: "Mom", phone: "+1 555-0101", status: "Active" },
                { id: 2, name: "Sister", phone: "+1 555-0102", status: "Active" },
                { id: 3, name: "Emergency Contact", phone: "+1 911", status: "Police" },
            ]);
            
            const routeInfo = `Duration: 15 min walk (1.2 km)\nRoute: Well-lit, main road preferred.`;

            // Data for Police Station and Traffic Status
            const nearestStation = {
                name: "Central Safety Precinct",
                distance: "0.8 km",
                time: "3 min drive",
                phone: "+917852469321 ",
                status: "24/7",
            };

            const trafficStatus = {
                crowdLevel: "High Foot Traffic (Moderate Risk)",
                safestPlace: "Main arterial roads / Well-lit areas", 
                trafficLevel: "Moderate",
            };
            
            // Hotspot data
            const hotspotData = {
                night: "Park area, back alleys (10 PM - 5 AM)",
                day: "Busy transportation hubs (Peak hours)",
                latestIncident: "No recent incidents reported in 48h.",
            };


            // Geolocation Fetch
            useEffect(() => {
                const fetchGeo = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude.toFixed(6); 
                                const lon = position.coords.longitude.toFixed(6);
                                
                                const newLocation = `Lat: ${lat}¬∞ Lon: ${lon}¬∞`;
                                setCurrentLocation(newLocation);
                                setRouteStart(newLocation);
                                setLocationError(null);
                            },
                            (error) => {
                                console.error("Geolocation Error:", error.message);
                                setLocationError("Could not retrieve real location. Showing mock data.");
                            },
                            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                        );
                    } else {
                        setLocationError("Geolocation not supported. Showing mock data.");
                    }
                };
                fetchGeo();
            }, []);
            
            // Cleanup timer on component unmount
            useEffect(() => {
                return () => {
                    if (sosPressTimerId) {
                        clearInterval(sosPressTimerId.interval);
                        clearTimeout(sosPressTimerId.timeout);
                    }
                };
            }, [sosPressTimerId]);


            // Function to handle the successful SOS alert activation
            const activateSOSAlert = () => {
                if (isSOSActive) return;
                setIsSOSActive(true);
                
                // Vital info structure for the modal
                const emergencyInfo = `
                    <ul class="text-left text-xs text-gray-300 space-y-1 mt-3 border-t border-red-700 pt-3">
                        <li class="flex justify-between items-center text-red-300">
                            <strong>COORDINATES:</strong> 
                            <span class="font-mono text-right text-base">${currentLocation}</span>
                        </li>
                        <li>
                            <strong>NEAREST POLICE:</strong> 
                            ${nearestStation.name} 
                            <a href="tel:${nearestStation.phone}" class="text-pink-400 hover:underline">(CALL ${nearestStation.phone})</a>
                        </li>
                        <li><strong>CROWD RISK:</strong> ${trafficStatus.crowdLevel}</li>
                        <li><strong>SAFEST PATH:</strong> ${trafficStatus.safestPlace}</li>
                    </ul>
                `;

                // Custom message box instead of alert()
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl text-center max-w-xs mx-4 transform scale-100 transition-transform duration-300 border border-red-500">
                        <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <h3 class="mt-2 text-lg leading-6 font-medium text-gray-100">EMERGENCY ALERT SENT!</h3>
                        <p class="mt-2 text-sm text-gray-400">Authorities and ${trustedContacts.length} contacts have been notified of your location. Use the info below if needed:</p>
                        ${emergencyInfo}
                        <button id="close-sos" class="mt-4 w-full justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                            I Am Safe Now
                        </button>
                    </div>
                `;
                document.body.appendChild(messageBox);
                
                document.getElementById('close-sos').onclick = () => {
                    messageBox.remove();
                    setIsSOSActive(false);
                };
            };
            
            // --- Press and Hold Logic (FIXED) ---
            const startSOSPress = (e) => {
                // Prevent default touch behavior (like scrolling)
                if (e.type.includes('touch')) e.preventDefault();
                
                if (isSOSActive || sosPressTimerId) return;

                // Reset progress and start interval
                setSosPressProgress(0);
                
                const step = 50; // Update every 50ms
                
                // Use a functional update for setSosPressProgress to avoid stale closures
                const interval = setInterval(() => {
                    setSosPressProgress(prev => {
                        const newProgress = prev + (step / PRESS_DURATION) * 100;
                        if (newProgress >= 100) {
                            clearInterval(interval);
                            // Activation will happen immediately after this state update completes
                            // We trigger the alert in the subsequent useEffect or here directly
                            activateSOSAlert();
                            return 100;
                        }
                        return newProgress;
                    });
                }, step);

                // Set a timerId containing both interval and timeout for cleanup
                const timeout = setTimeout(() => {
                    clearInterval(interval);
                    // The activation should ideally be handled inside the interval for consistency,
                    // but we clear the timer here anyway to ensure no memory leaks.
                }, PRESS_DURATION);

                setSosPressTimerId({ interval, timeout });
            };

            const cancelSOSPress = () => {
                if (sosPressTimerId) {
                    clearInterval(sosPressTimerId.interval);
                    clearTimeout(sosPressTimerId.timeout);
                    setSosPressTimerId(null);
                    setSosPressProgress(0); // Reset progress
                }
            };
            // --- End Press and Hold Logic ---


            // Gemini API Call to fetch Safety Analysis with Google Search Grounding
            const fetchSafetyAnalysis = useCallback(async (query, retries = 0) => {
                if (!query.trim()) return;
                setIsLoading(true);
                setSafetyAnalysis(null);
                
                const systemPrompt = "Act as a specialized safety analyst for a women's security application. Your analysis must be grounded in real-time information from recent news/reports. Provide a concise, objective assessment of the requested location/route's safety profile, focusing on recent incident reports, general crime statistics, and time-of-day risks. Conclude with a clear recommendation: 'Safe to travel,' 'Exercise Caution,' or 'Avoid travel.' The output must be a single paragraph. Focus heavily on safety risks for women.";

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries < 5) {
                            const delay = Math.pow(2, retries) * 1000;
                            console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return fetchSafetyAnalysis(query, retries + 1);
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title); 
                        }
                        setSafetyAnalysis({ text, sources });
                    } else {
                        setSafetyAnalysis({ text: "Error: Could not retrieve a valid safety analysis from the AI model. Try a different query.", sources: [] });
                    }

                } catch (error) {
                    console.error('API or network error:', error);
                    setSafetyAnalysis({ text: `Network Error: Failed to fetch analysis. ${error.message}`, sources: [] });
                } finally {
                    setIsLoading(false);
                }
            }, []);
            
            // Voice Input Simulation
            const handleVoiceInput = () => {
                if (isRecording) {
                    setIsRecording(false);
                    // Update search query based on current route planning
                    setSearchQuery(`Is the route from ${routeStart} to ${routeEnd} safe right now?`);
                    setTimeout(() => {
                        // Using custom message box instead of alert()
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                        messageBox.innerHTML = `<div class="bg-gray-800 p-4 rounded-xl text-center text-sm text-white">Voice command recorded! Tap 'Analyze Safety Now' to get the risk report.</div>`;
                        document.body.appendChild(messageBox);
                        setTimeout(() => messageBox.remove(), 2000);
                    }, 500);
                } else {
                    setIsRecording(true);
                    setTimeout(() => {
                        if (isRecording) {
                             setIsRecording(false);
                        }
                    }, 3000);
                }
            };
            
            // TTS Output Simulation
            const handleTTS = () => {
                if (!safetyAnalysis || isSpeaking) return;
                
                setIsSpeaking(true);
                console.log("Simulating speech for:", safetyAnalysis.text);
                
                const estimatedDuration = safetyAnalysis.text.length * 50; 
                
                setTimeout(() => {
                    setIsSpeaking(false);
                }, Math.min(estimatedDuration, 5000)); 
            };


            // Component for the simulated Map/Route panels
            const MapPanel = ({ title, content, icon, isRoutePlanner, routeStart, setRouteStart, routeEnd, setRouteEnd }) => {
                
                // --- Location Data Extraction for Map and Display ---
                let coords = '37.774929,-122.419416'; // Default mock coordinates
                let displayContent = content;

                if (!isRoutePlanner) {
                    // Extract coordinates from the combined string "Lat: X¬∞ Lon: Y¬∞"
                    const latMatch = content.match(/Lat: ([\d\.\-]+)¬∞/);
                    const lonMatch = content.match(/Lon: ([\d\.\-]+)¬∞/);
                    
                    if (latMatch && lonMatch) {
                        // Format for Google Maps query
                        coords = `${latMatch[1]},${lonMatch[1]}`;
                    }
                }
                // Google Maps iframe source (simulating an embedded map centered on coords)
                const mapSrc = `https://maps.google.com/maps?q=${coords}&z=14&t=m&output=embed&iwloc=near`;
                // --- End Extraction ---


                const mapContent = isRoutePlanner ? (
                    <div className="card-content p-2 space-y-2">
                        {/* Route Planner Inputs */}
                        <input
                            type="text"
                            placeholder="Start (e.g., Home)"
                            value={routeStart}
                            onChange={(e) => setRouteStart(e.target.value)}
                            className="w-full p-2 border border-gray-700 rounded-lg bg-gray-800 text-white text-xs placeholder-gray-500"
                        />
                        <input
                            type="text"
                            placeholder="Destination (e.g., Work)"
                            value={routeEnd}
                            onChange={(e) => setRouteEnd(e.target.value)}
                            className="w-full p-2 border border-gray-700 rounded-lg bg-gray-800 text-white text-xs placeholder-gray-500"
                        />
                        <div className="text-center mt-2">
                            <pre className="text-xs text-green-300 whitespace-pre-wrap font-mono">{content}</pre>
                            <p className="mt-1 text-xs text-gray-500">(Route simulated)</p>
                        </div>
                    </div>
                ) : (
                    // CURRENT LOCATION VIEW (with Google Maps Iframe Simulation)
                    <div className="card-content items-center justify-start text-center">
                        {/* Map Visualization Container using iframe for Google Maps simulation */}
                        <div className="map-container"> 
                            <iframe 
                                width="100%" 
                                height="100%" 
                                frameBorder="0" 
                                scrolling="no" 
                                marginHeight="0" 
                                marginWidth="0" 
                                src={mapSrc}
                                title="Live Location Map"
                                allowFullScreen="" 
                                aria-hidden="false" 
                                tabIndex="0"
                                style={{ borderRadius: '12px', position: 'relative', zIndex: 1 }}
                            ></iframe>
                            {/* Marker overlay - positioned using CSS */}
                            <span className="map-marker" style={{ zIndex: 2 }}>üìç</span>
                        </div>
                        
                        {/* Location Text (Combined Lat/Lon) */}
                        <div className="mt-2 w-full text-center">
                            <span className="block text-xs text-gray-300 font-mono">{displayContent}</span>
                            <p className="mt-1 text-xs text-gray-500">(Live GPS Location)</p>
                        </div>
                    </div>
                );

                return (
                    <div className="w-1/2 flex-shrink-0">
                        <div className="card h-full">
                            <div className="card-title">
                                <span className="mr-2">{icon}</span>
                                {title}
                            </div>
                            {mapContent}
                        </div>
                    </div>
                );
            };
            
            // New Component for Trusted Contacts
            const ContactPanel = () => {
                const [newContactName, setNewContactName] = useState('');
                const [newContactPhone, setNewContactPhone] = useState('');

                const handleAddContact = () => {
                    if (newContactName.trim() === '' || newContactPhone.trim() === '') {
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                        messageBox.innerHTML = `<div class="bg-red-800 p-4 rounded-xl text-center text-sm text-white">Please enter both name and phone number.</div>`;
                        document.body.appendChild(messageBox);
                        setTimeout(() => messageBox.remove(), 2000);
                        return;
                    }
                    
                    const newId = trustedContacts.length + 1;
                    const newContact = { 
                        id: newId, 
                        name: newContactName.trim(), 
                        phone: newContactPhone.trim(), 
                        status: "Active" 
                    };
                    
                    setTrustedContacts([...trustedContacts, newContact]);
                    setNewContactName('');
                    setNewContactPhone('');
                    
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                    messageBox.innerHTML = `<div class="bg-green-800 p-4 rounded-xl text-center text-sm text-white">Contact Added: ${newContact.name}</div>`;
                    document.body.appendChild(messageBox);
                    setTimeout(() => messageBox.remove(), 2000);
                };
                
                return (
                    <div className="w-full flex-shrink-0">
                        <div className="card h-full min-h-[100px] p-2">
                            <div className="card-title text-pink-500 mb-2">
                                <span className="mr-2">ü´Ç</span>Trusted Contacts ({trustedContacts.length})
                            </div>
                            
                            {/* Input Form Section */}
                            <div className="flex flex-col space-y-2 pb-3 border-b border-gray-700/50 mb-3">
                                <input
                                    type="text"
                                    placeholder="Contact Name"
                                    value={newContactName}
                                    onChange={(e) => setNewContactName(e.target.value)}
                                    className="w-full p-2 border border-gray-700 rounded-lg bg-gray-800 text-white text-xs placeholder-gray-500"
                                />
                                <div className="flex space-x-2">
                                    <input
                                        type="tel"
                                        placeholder="Phone Number"
                                        value={newContactPhone}
                                        onChange={(e) => setNewContactPhone(e.target.value)}
                                        className="flex-grow p-2 border border-gray-700 rounded-lg bg-gray-800 text-white text-xs placeholder-gray-500"
                                    />
                                    <button
                                        onClick={handleAddContact}
                                        className="bg-pink-600 text-white text-xs px-3 py-1 rounded-lg hover:bg-pink-700 transition active:scale-[0.98] font-semibold"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                            
                            {/* Contact List Section */}
                            <div className="card-content pt-1 max-h-[120px] overflow-y-auto">
                                <ul className="space-y-1">
                                    {trustedContacts.map(contact => (
                                        <li key={contact.id} className="flex justify-between items-center text-xs text-gray-300">
                                            <span>{contact.name}</span>
                                            <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold ${
                                                contact.status === 'Police' ? 'bg-red-800 text-red-100' : 
                                                contact.status === 'Active' ? 'bg-green-800 text-green-100' : 
                                                'bg-yellow-800 text-yellow-100'
                                            }`}>
                                                {contact.status}
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // Component for Nearest Police Station
            const NearestPoliceStationPanel = () => {
                // Using the shared nearestStation data
                return (
                    <div className="w-1/2 flex-shrink-0">
                        <div className="card h-full">
                            <div className="card-title text-blue-400">
                                <span className="mr-2">üö®</span>Nearest Police Station
                            </div>
                            <div className="card-content items-center justify-center text-center">
                                <span className="block text-xl mb-1">üó∫Ô∏è</span>
                                <div className="text-sm text-white font-semibold">{nearestStation.name}</div>
                                <div className="text-xs text-gray-400 mt-1">
                                    {nearestStation.distance} away ‚Ä¢ {nearestStation.time}
                                </div>
                                <div className={`text-[10px] font-bold mt-2 px-2 py-1 rounded-full ${
                                    nearestStation.status === '24/7' ? 'bg-green-700/50 text-green-300' : 'bg-yellow-700/50 text-yellow-300'
                                }`}>
                                    Status: {nearestStation.status}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // New Component for Traffic and Crowd Status
            const TrafficCrowdPanel = () => {
                // Using the shared trafficStatus data
                const crowdIcon = trafficStatus.crowdLevel.includes("High") ? 'üö∂‚Äç‚ôÄÔ∏èüö∂' : 'üö∂';
                const riskColor = trafficStatus.crowdLevel.includes("Moderate Risk") ? 'text-yellow-400' : 'text-green-400';

                return (
                    <div className="w-1/2 flex-shrink-0">
                        <div className="card h-full">
                            <div className="card-title text-yellow-400">
                                <span className="mr-2">üö¶</span>Traffic / Crowd Status
                            </div>
                            <div className="card-content items-center justify-center text-center">
                                <span className="block text-xl mb-1">{crowdIcon}</span>
                                <div className="text-sm text-white font-semibold">Crowd: <span className={riskColor}>{trafficStatus.crowdLevel}</span></div>
                                <div className="text-xs text-gray-400 mt-1">
                                    Traffic: {trafficStatus.trafficLevel} (Normal speed)
                                </div>
                                <div className="text-[10px] font-bold mt-2 px-2 py-1 rounded-full bg-gray-700/50 text-gray-300">
                                    Data from Live Maps
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // New Component for Hotspot Mapping
            const HotspotMappingPanel = () => {
                return (
                    <div className="w-full flex-shrink-0">
                        <div className="card h-full">
                            <div className="card-title text-orange-400">
                                <span className="mr-2">üî•</span>Local Risk Hotspots
                            </div>
                            <div className="card-content p-2 space-y-2 text-sm text-gray-300">
                                <div className="flex justify-between border-b border-gray-700/50 pb-1">
                                    <span className="font-semibold text-white">High Risk (Night)</span>
                                    <span className="text-orange-300 text-xs">{hotspotData.night}</span>
                                </div>
                                <div className="flex justify-between border-b border-gray-700/50 pb-1">
                                    <span className="font-semibold text-white">Moderate Risk (Day)</span>
                                    <span className="text-yellow-300 text-xs">{hotspotData.day}</span>
                                </div>
                                <div className="text-center pt-2 text-[10px] text-gray-500">
                                    {hotspotData.latestIncident} - Based on localized crime data (simulated).
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Component for the Gemini AI Analysis panel
            const SafetyAnalysisPanel = () => {
                const title = "Gen AI analysis";
                return (
                    <div className="w-full flex-shrink-0">
                        <div className="card gemini-card h-full">
                            <div className="card-title text-pink-500">
                                <span className="text-xl mr-2">üîé‚ú®</span>
                                {title}
                            </div>
                            <div className="card-content p-2">
                                {/* Text and Voice Input */}
                                <div className="flex items-center space-x-2 mb-3">
                                    <textarea
                                        className="flex-grow h-16 p-2 border border-gray-700 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-gray-800 text-white text-sm placeholder-gray-500 resize-none"
                                        placeholder={isRecording ? "Listening..." : "Query (e.g., 'Is this area safe tonight?')."}
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        disabled={isRecording || isLoading}
                                    />
                                    <button
                                        onClick={handleVoiceInput}
                                        className={`w-10 h-10 flex items-center justify-center rounded-full shadow-lg transition duration-200 ${
                                            isRecording ? 'bg-red-500 mic-pulse' : 'bg-pink-600 hover:bg-pink-700'
                                        }`}
                                        disabled={isLoading}
                                        title={isRecording ? "Stop Recording" : "Start Voice Input"}
                                    >
                                        {/* Mic SVG Icon */}
                                        <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path fillRule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-2.167a.75.75 0 00-.75.75c0 .76-.11 1.503-.314 2.222a1.05 1.05 0 01-.84 1.402c-.886.233-1.815.35-2.766.35s-1.88-.117-2.766-.35a1.05 1.05 0 01-.84-1.402c-.204-.719-.314-1.462-.314-2.222a.75.75 0 00-.75-.75H3a7.001 7.001 0 005.86 6.93V18a1 1 0 102 0v-2.07zm3-2.007a.75.75 0 00.75.75h1.5a.75.75 0 000-1.5h-1.5a.75.75 0 00-.75.75zM5 13.673a.75.75 0 00.75.75h1.5a.75.75 0 000-1.5H5.75a.75.75 0 00-.75.75z" clipRule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                {/* Analyze Button */}
                                <button
                                    onClick={() => fetchSafetyAnalysis(searchQuery)}
                                    className={`w-full py-2 text-white font-semibold rounded-lg shadow-md transition duration-150 text-sm mb-3 ${
                                        isLoading ? 'bg-pink-800 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700 active:scale-[0.98]'
                                    }`}
                                    disabled={isLoading || isRecording}
                                >
                                    {isLoading ? (
                                        <div className="flex items-center justify-center">
                                            <svg className="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Analyzing...
                                        </div>
                                    ) : (
                                        'Analyze Safety Now'
                                    )}
                                </button>
                                
                                {/* Analysis Output and TTS Button */}
                                <div className="mt-3 p-3 bg-gray-700/50 rounded-lg text-xs min-h-[80px]">
                                    <div className="flex justify-between items-start mb-2">
                                        {/* Color the conclusion based on the safety recommendation */}
                                        {safetyAnalysis ? (
                                            <p className={`font-medium ${
                                                safetyAnalysis.text.includes('Avoid travel') ? 'text-red-300' :
                                                safetyAnalysis.text.includes('Exercise Caution') ? 'text-yellow-300' :
                                                'text-green-300'
                                            }`}>{safetyAnalysis.text}</p>
                                        ) : (
                                            <p className="text-gray-500">Enter your query or use the microphone to start.</p>
                                        )}
                                        
                                        {safetyAnalysis && (
                                            <button
                                                onClick={handleTTS}
                                                className={`ml-2 w-6 h-6 flex items-center justify-center rounded-full transition duration-200 ${
                                                    isSpeaking ? 'bg-pink-400 animate-pulse' : 'bg-pink-600 hover:bg-pink-700'
                                                }`}
                                                title={isSpeaking ? "Stop Speaking" : "Read Analysis Aloud"}
                                                disabled={isSpeaking}
                                            >
                                                {/* Speaker SVG Icon */}
                                                <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                    <path fillRule="evenodd" d="M9.383 3.093A1 1 0 0110 4v12a1 1 0 01-1.383.907L5.67 13H3a1 1 0 01-1-1V8a1 1 0 011-1h2.67l3.313-3.907zM16.5 10a4.5 4.5 0 00-2.313-4.081A.75.75 0 0114 6.643a3 3 0 010 6.714.75.75 0 01.187-.692 4.5 4.5 0 002.313-4.081z" clipRule="evenodd"></path>
                                                </svg>
                                            </button>
                                        )}
                                    </div>
                                    
                                    {safetyAnalysis?.sources.length > 0 && (
                                        <div className="mt-3 pt-2 border-t border-gray-600">
                                            <p className="font-semibold text-xs text-pink-400 mb-1">Sources:</p>
                                            <ul className="space-y-1">
                                                {safetyAnalysis.sources.slice(0, 3).map((source, index) => (
                                                    <li key={index} className="text-xs text-gray-400 truncate">
                                                        <a href={source.uri} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                                            {index + 1}. {source.title || source.uri}
                                                        </a>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // --- SMARTWATCH APP COMPONENT ---
            const SmartwatchApp = ({ startSOSPress, cancelSOSPress, isSOSActive, currentLocation, nearestStation, trafficStatus, sosPressProgress }) => {
                const crowdIcon = trafficStatus.crowdLevel.includes("High") ? 'üö∂‚Äç‚ôÄÔ∏èüö∂' : 'üö∂';
                const riskColor = trafficStatus.crowdLevel.includes("Moderate Risk") ? 'text-yellow-400' : 'text-red-400';
                
                // Calculate fill for the ring
                const strokeDashoffset = 40 * (1 - sosPressProgress / 100); 

                return (
                    <div className="watch-frame">
                        <div className="text-sm text-gray-400 mt-2">SafePath Watch</div>
                        
                        {/* Status Row */}
                        <div className="flex justify-between w-full px-2 text-xs">
                            <div className="text-left">
                                <span className="block text-pink-400">üìç GPS:</span>
                                <span className="font-mono text-[10px] text-gray-200">
                                    {currentLocation.split('¬∞')[0]}...
                                </span>
                            </div>
                            <div className="text-right">
                                <span className="block text-blue-400">üö® Police:</span>
                                <span className="font-mono text-[10px] text-gray-200">{nearestStation.distance}</span>
                            </div>
                        </div>

                        {/* Large SOS Button (Main Interaction) */}
                        <div className="relative">
                            {/* SVG Ring for Progress (Watch Style) */}
                            <svg className="w-44 h-44 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" viewBox="0 0 40 40">
                                <circle 
                                    cx="20" 
                                    cy="20" 
                                    r="18" 
                                    fill="transparent" 
                                    stroke="#333" 
                                    strokeWidth="2" 
                                />
                                <circle 
                                    cx="20" 
                                    cy="20" 
                                    r="18" 
                                    fill="transparent" 
                                    stroke={sosPressProgress > 0 ? '#ec4899' : 'transparent'} 
                                    strokeWidth="4" 
                                    strokeDasharray="113.1" /* Circumference of circle with r=18 * 2 * PI = 113.09 */
                                    strokeDashoffset={strokeDashoffset} 
                                    strokeLinecap="round"
                                    transform="rotate(-90 20 20)"
                                />
                            </svg>

                            <button
                                onMouseDown={startSOSPress}
                                onMouseUp={cancelSOSPress}
                                onTouchStart={startSOSPress}
                                onTouchEnd={cancelSOSPress}
                                className={`w-40 h-40 flex flex-col items-center justify-center rounded-full font-extrabold shadow-2xl transform transition-all duration-300 ease-in-out relative ${
                                    isSOSActive 
                                    ? 'bg-red-800 ring-4 ring-red-500 animate-pulse text-3xl'
                                    : 'bg-red-600 hover:bg-red-700 active:scale-95 text-2xl'
                                } text-white`}
                                disabled={isSOSActive}
                            >
                                {isSOSActive ? (
                                    <>
                                        <div className="text-sm">ALERTING</div>
                                        <div className="text-xs font-normal">SENT</div>
                                    </>
                                ) : sosPressProgress > 0 ? (
                                    <>
                                        <div className="text-lg font-mono">{Math.ceil(3 - (3 * sosPressProgress / 100))}s</div>
                                        <div className="text-xs font-normal">HOLD TO ALERT</div>
                                    </>
                                ) : (
                                    'SOS'
                                )}
                            </button>
                        </div>

                        {/* Crowd/Safest Place Info */}
                        <div className="text-center w-full pb-3">
                            <div className={`text-sm font-semibold ${riskColor}`}>
                                {crowdIcon} Safest: {trafficStatus.safestPlace.split('/')[0].trim()}
                            </div>
                            <div className="text-[10px] text-gray-500 mt-1">
                                Hold SOS for 3 seconds to alert.
                            </div>
                        </div>
                    </div>
                );
            };
            // --- END SMARTWATCH APP COMPONENT ---


            const MobileApp = () => (
                <div className="phone">
                    <div className="screen">

                        {/* SOS Banner (Dynamic) */}
                        <div 
                            className={`sos-banner ${isSOSActive ? 'active' : ''}`}
                            onMouseDown={startSOSPress}
                            onMouseUp={cancelSOSPress}
                            onTouchStart={startSOSPress}
                            onTouchEnd={cancelSOSPress}
                            onContextMenu={(e) => {e.preventDefault(); if (!isSOSActive) startSOSPress(e);}} 
                        >
                             {/* Progress Bar Fill */}
                            <div className="sos-progress-fill" style={{ width: `${sosPressProgress}%` }}></div>
                            
                            <div className="sos-content">
                                <div className="sos-title">
                                    {isSOSActive ? 'ALERTING' : sosPressProgress > 0 ? `HOLDING (${Math.ceil(3 - (3 * sosPressProgress / 100))}s)` : 'SOS'}
                                </div>
                                <div className="sos-subtitle">
                                    {isSOSActive ? 
                                        `Alerting ${trustedContacts.length} contacts and authorities.` : 
                                        sosPressProgress > 0 ? 'Release to cancel. Hold for 3 seconds to activate.' : 'Press and hold for 3 seconds to alert police & family.'
                                    }
                                </div>
                            </div>
                        </div>

                        {/* Location Error Display */}
                        {locationError && (
                             <div className="bg-yellow-900/50 p-2 text-yellow-300 text-xs rounded-lg text-center" role="alert">
                                 <p>{locationError}</p>
                            </div>
                        )}

                        {/* Content Grid (Flexbox used to enforce panel layout) */}
                        <div className="flex flex-col gap-3 scrollable-content">
                            
                            {/* Row 1: Current Location and Route Planner (Side by Side) */}
                            <div className="flex gap-3 w-full">
                                <MapPanel 
                                    title="Current Location" 
                                    content={currentLocation} 
                                    icon="üìç"
                                />
                                <MapPanel 
                                    title="Safe Route Planner" 
                                    content={routeInfo} 
                                    icon="‚û°Ô∏è"
                                    isRoutePlanner={true}
                                    routeStart={routeStart}
                                    setRouteStart={setRouteStart}
                                    routeEnd={routeEnd}
                                    setRouteEnd={setRouteEnd}
                                />
                            </div>

                            {/* Row 2: Nearest Police Station and Traffic/Crowd (Side by Side) */}
                            <div className="flex gap-3 w-full">
                                <NearestPoliceStationPanel />
                                <TrafficCrowdPanel />
                            </div>
                            
                            {/* NEW Row 3: Hotspot Mapping (Full Width) */}
                            <div className="flex w-full">
                                <HotspotMappingPanel />
                            </div>

                            {/* Row 4: Gemini Safety Analysis (Full Width) */}
                            <div className="flex w-full">
                                <SafetyAnalysisPanel />
                            </div>
                            
                            {/* Row 5: Trusted Contacts Panel (Full Width) */}
                            <div className="flex w-full">
                                <ContactPanel />
                            </div>
                        </div>
                        
                        <div className="text-center text-xs text-gray-500 mt-auto">
                            Location sharing is always active when SafePath is running.
                        </div>
                    </div>
                </div>
            );


            // Main App Render Logic
            return (
                <div className="flex flex-col items-center justify-center min-h-screen">
                    <button
                        onClick={() => setIsWatchView(!isWatchView)}
                        className="mb-4 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition"
                    >
                        Switch to {isWatchView ? 'Mobile View' : 'Smartwatch View'}
                    </button>
                    {isWatchView ? (
                        <SmartwatchApp 
                            startSOSPress={startSOSPress} 
                            cancelSOSPress={cancelSOSPress} 
                            isSOSActive={isSOSActive} 
                            currentLocation={currentLocation} 
                            nearestStation={nearestStation} 
                            trafficStatus={trafficStatus}
                            sosPressProgress={sosPressProgress}
                        />
                    ) : (
                        <MobileApp />
                    )}
                </div>
            );
        };

        // --- React Code End ---
        
        // Render the application
        const rootElement = document.getElementById('root');
        ReactDOM.createRoot(rootElement).render(<App />);
    </script>
</body>

</html>
